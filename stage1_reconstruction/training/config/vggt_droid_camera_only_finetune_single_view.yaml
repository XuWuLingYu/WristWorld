defaults:
  - vggt_droid_dataset.yaml

exp_name: vggt_droid_camera_only_finetune_single_view
img_size: 518  # Square image size divisible by patch_size=14 (1274=14Ã—91)
num_workers: 0  # Training workers
seed_value: 42
accum_steps: 3
patch_size: 14
limit_train_batches: 800
limit_val_batches: 50
view_num: 1

## è§†è§’æ•°é‡é€šè¿‡ view_num æ§åˆ¶ï¼Œæ­¤å¤„ä¸ºå•è§†è§’ï¼ˆext1ï¼‰

# æ·»åŠ early validationé…ç½®
early_validation:
  enabled: True  # å¯ç”¨early validation
  step: 5        # åœ¨ç¬¬5æ­¥è¿›è¡Œearly validation
  limit_batches: 50  # é™åˆ¶early validationçš„batchæ•°é‡

logging:
  log_dir: logs
  log_visuals: True  # å¯ç”¨å¯è§†åŒ–
  log_freq: 1
  log_level_primary: INFO  # æ”¹ä¸ºINFOå‡å°‘debugä¿¡æ¯
  log_level_secondary: WARNING
  all_ranks: False
  tensorboard_writer:
    _target_: train_utils.tb_writer.TensorBoardLogger
    path: ${logging.log_dir}/tensorboard
  
  # å¢åŠ å¯è§†åŒ–é…ç½®
  log_visual_frequency:
    train: 100  # æ¯100æ­¥è®°å½•ä¸€æ¬¡è®­ç»ƒå¯è§†åŒ–
    val: 1     # æ¯ä¸ªepochè®°å½•éªŒè¯å¯è§†åŒ–
  
  visuals_keys_to_log:
    train:
      keys_to_log: ["depth", "world_points"]  # ä¿æŒå¯è§†åŒ–åŠŸèƒ½
      modality: "image"
    val:
      keys_to_log: ["depth", "world_points", "depth_conf"]  # ä¿æŒå¯è§†åŒ–åŠŸèƒ½
      modality: "image"
  
  visuals_per_batch_to_log: 4
  video_logging_fps: 10  # è§†é¢‘æ—¥å¿—å¸§ç‡
  scalar_keys_to_log:
    train:
      keys_to_log:
        - loss_objective
        - loss_camera  # ğŸ¯ åªä¿ç•™cameraç›¸å…³æŸå¤±
        - loss_FL
        # ğŸš« ç§»é™¤depthç›¸å…³æŸå¤±
        # - loss_conf_depth
        # - loss_reg_depth
        # - loss_grad_depth
        # ğŸš« ç§»é™¤pointç›¸å…³æŸå¤±
        # - loss_conf_point
        # - loss_reg_point
        # - loss_grad_point
        - loss_wrist  # ğŸ¯ ä¿ç•™wristç›¸å…³æŸå¤±
        - loss_wrist_FL
        - loss_projection  # ğŸ†• æ·»åŠ projection lossæ—¥å¿—
        - valid_track_points  # ğŸ†• æ·»åŠ æœ‰æ•ˆtrackç‚¹æ•°é‡
        - total_track_points  # ğŸ†• æ·»åŠ æ€»trackç‚¹æ•°é‡
        - depth_loss_count  # ğŸ†• æ·»åŠ æ·±åº¦æŸå¤±è®¡æ•°
        - uv_loss_sum  # ğŸ†• æ·»åŠ UVæŸå¤±æ€»å’Œ
        - depth_loss_sum  # ğŸ†• æ·»åŠ æ·±åº¦æŸå¤±æ€»å’Œ
    val:
      keys_to_log:
        - loss_objective
        - loss_camera  # ğŸ¯ åªä¿ç•™cameraç›¸å…³æŸå¤±
        - loss_FL
        # ğŸš« ç§»é™¤depthç›¸å…³æŸå¤±
        # - loss_conf_depth
        # - loss_reg_depth
        # - loss_grad_depth
        # ğŸš« ç§»é™¤pointç›¸å…³æŸå¤±
        # - loss_conf_point
        # - loss_reg_point
        # - loss_grad_point
        - loss_wrist  # ğŸ¯ ä¿ç•™wristç›¸å…³æŸå¤±
        - loss_wrist_FL
        - loss_projection  # ğŸ†• æ·»åŠ projection lossæ—¥å¿—
        - valid_track_points  # ğŸ†• æ·»åŠ æœ‰æ•ˆtrackç‚¹æ•°é‡
        - total_track_points  # ğŸ†• æ·»åŠ æ€»trackç‚¹æ•°é‡
        - depth_loss_count  # ğŸ†• æ·»åŠ æ·±åº¦æŸå¤±è®¡æ•°
        - uv_loss_sum  # ğŸ†• æ·»åŠ UVæŸå¤±æ€»å’Œ
        - depth_loss_sum  # ğŸ†• æ·»åŠ æ·±åº¦æŸå¤±æ€»å’Œ

checkpoint:
  save_dir: logs/${exp_name}/ckpts
  save_freq: 5
  resume_checkpoint_path: logs/vggt_droid_camera_only_finetune/ckpts/checkpoint.pt
  strict: False

# ğŸ¯ å…³é”®ä¿®æ”¹ï¼šæŸå¤±å‡½æ•°é…ç½® - åªä¿ç•™cameraå’Œwristè®­ç»ƒ
loss:
  _target_: loss.MultitaskLoss
  camera: 
    weight: 5.0
    loss_type: "l1"
  
  # ğŸš« ç¦ç”¨depthæŸå¤±è®­ç»ƒï¼ˆæ¨¡å‹ä»äº§ç”Ÿdepthé¢„æµ‹ç”¨äºå¯è§†åŒ–ï¼Œä½†ä¸è®¡ç®—æŸå¤±ï¼‰
  depth:
    weight: 0.0  # è®¾ç½®æƒé‡ä¸º0ï¼Œç­‰æ•ˆäºç¦ç”¨
    gradient_loss_fn: "grad" 
    valid_range: 0.98
    mask_nan: True
    robust_loss: True
  
  # ğŸš« ç¦ç”¨pointæŸå¤±è®­ç»ƒï¼ˆæ¨¡å‹ä»äº§ç”Ÿpointé¢„æµ‹ç”¨äºå¯è§†åŒ–ï¼Œä½†ä¸è®¡ç®—æŸå¤±ï¼‰  
  point:
    weight: 0.0  # è®¾ç½®æƒé‡ä¸º0ï¼Œç­‰æ•ˆäºç¦ç”¨
    gradient_loss_fn: "normal"
    valid_range: 0.98
  
  track: null  # ä¿æŒtrack losså…³é—­
  
  wrist:  # ğŸ¯ ä¿ç•™wrist poseç›‘ç£
    weight: 10.0 # Wrist poseç›‘ç£æƒé‡
    loss_type: "l1"
    gamma: 0.6
    pose_encoding_type: "absT_quaR_FoV"
    weight_trans: 0.0  # Translation component weight
    weight_rot: 0.0    # Rotation component weight
    weight_focal: 1.0  # Focal component weight (lower for wrist)
    mask_invalid: False  # maskæ‰æ— æ•ˆwrist poseæ•°æ®
  
  # ğŸ†• æ·»åŠ projection lossé…ç½®
  projection:
    weight: 1.0  # Projection lossæƒé‡
    depth_loss_weight: 1  # Zä¸ºè´Ÿæ•°æ—¶çš„æ·±åº¦æŸå¤±æƒé‡
    track_confidence_threshold: 0.2  # Trackç‚¹ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆé™ä½ï¼‰
    max_track_points: 1024  # æœ€å¤§trackç‚¹æ•°é‡

optim:
  param_group_modifiers: False

  optimizer:
    _target_: torch.optim.AdamW
    weight_decay: 0.05

  # ğŸ¯ ä¿®æ”¹å†»ç»“ç­–ç•¥ï¼šå†»ç»“depthå’Œpointç›¸å…³æ¨¡å—
  frozen_module_names: 
    - "aggregator*"     # å†»ç»“æ‰€æœ‰aggregatorç›¸å…³æ¨¡å—
    - "depth_head*"     # ğŸ†• å†»ç»“depth headï¼Œä¿æŒé¢„è®­ç»ƒæƒé‡ç”¨äºå¯è§†åŒ–
    - "point_head*"     # ğŸ†• å†»ç»“point headï¼Œä¿æŒé¢„è®­ç»ƒæƒé‡ç”¨äºå¯è§†åŒ–

  amp:
    enabled: True
    amp_dtype: bfloat16
  
  # ğŸ¯ ä¿®æ”¹æ¢¯åº¦å‰ªåˆ‡ï¼šåªé’ˆå¯¹cameraå’Œwrist head
  gradient_clip:
    _target_: train_utils.gradient_clip.GradientClipper
    configs:
      - module_name: ["camera_head"]  # ğŸ¯ åªä¿ç•™camera_head
        max_norm: 1.0
        norm_type: 2
      - module_name: ["wrist_head"]   # ğŸ¯ ä¿ç•™wrist_head
        max_norm: 1.0
        norm_type: 2

  # ğŸ¯ ä¿®æ”¹åˆ†ç»„å­¦ä¹ ç‡é…ç½®ï¼šåªä¼˜åŒ–cameraå’Œwrist head
  options:
    lr:
      # Wrist head: 2e-5
      - param_names: ["wrist_head*"]
        scheduler:
          _target_: fvcore.common.param_scheduler.CompositeParamScheduler
          schedulers:
            - _target_: fvcore.common.param_scheduler.LinearParamScheduler
              start_value: 1e-8
              end_value: 2e-5
            - _target_: fvcore.common.param_scheduler.CosineParamScheduler
              start_value: 2e-5
              end_value: 1e-8
          lengths: [0.05, 0.95]
          interval_scaling: ['rescaled', 'rescaled']
      
      # Camera head: 5e-6 (ğŸš« ç§»é™¤depth_headå’Œpoint_head)
      - param_names: ["camera_head*"]
        scheduler:
          _target_: fvcore.common.param_scheduler.CompositeParamScheduler
          schedulers:
            - _target_: fvcore.common.param_scheduler.LinearParamScheduler
              start_value: 1e-9
              end_value: 5e-6
            - _target_: fvcore.common.param_scheduler.CosineParamScheduler
              start_value: 5e-6
              end_value: 1e-9
          lengths: [0.05, 0.95]
          interval_scaling: ['rescaled', 'rescaled']
    
    weight_decay:
      # æ‰€æœ‰å‚æ•°ä½¿ç”¨ç›¸åŒçš„weight decay
      - scheduler:
          _target_: fvcore.common.param_scheduler.ConstantParamScheduler
          value: 0.05

max_epochs: 100

# ğŸ¯ å…³é”®ï¼šæ¨¡å‹é…ç½®ä¿æŒå®Œæ•´æ¨ç†èƒ½åŠ›ï¼Œä½†åªè®­ç»ƒcameraå‚æ•°
model:
  _target_: vggt.models.vggt.VGGT
  img_size: ${img_size}
  patch_size: ${patch_size}
  embed_dim: 1024
  enable_camera: True   # ğŸ¯ ä¿ç•™Main camera pose prediction
  enable_depth: True    # ğŸ¯ ä¿ç•™Depth predictionï¼ˆç”¨äºæ¨ç†å’Œå¯è§†åŒ–ï¼‰
  enable_point: True    # ğŸ¯ ä¿ç•™ç‚¹äº‘é¢„æµ‹ï¼ˆç”¨äºæ¨ç†å’Œå¯è§†åŒ–ï¼‰
  enable_track: True    # å¯ç”¨tracké¢„æµ‹ç”¨äºevaluation
  enable_wrist: True    # ğŸ¯ ä¿ç•™wrist poseé¢„æµ‹
  
  # ğŸ”¥ NEW: WristHeadé…ç½® - ä½¿ç”¨å…¨éƒ¨tokens + å¤šå±‚Transformerèšåˆ
  wrist_head_config:
    token_aggregation: "attention"  # "attention", "mean", "weighted_mean"
    
    # å¤šå±‚Transformer tokenèšåˆå‚æ•°
    aggregation_num_layers: 3       # Transformerå±‚æ•°
    aggregation_num_heads: 8        # æ³¨æ„åŠ›å¤´æ•°  
    aggregation_dropout: 0.1        # Dropoutæ¯”ä¾‹
    
    # åŸæœ‰å‚æ•°
    trunk_depth: 4
    num_heads: 16
    mlp_ratio: 4
    init_values: 0.01
    
  pretrained: "facebook/VGGT-1B"  # Load pretrained model
  use_lora: False  # ä¸ä½¿ç”¨LoRAï¼Œç›´æ¥fine-tune
  lora_rank: 16  
  lora_alpha: 32  

# æ·»åŠ åˆ†å¸ƒå¼è®­ç»ƒé…ç½®
distributed:
  backend: nccl
  comms_dtype: None
  find_unused_parameters: False
  timeout_mins: 30
  gradient_as_bucket_view: True
  bucket_cap_mb: 25
  broadcast_buffers: True

# æ·»åŠ CUDAé…ç½®
cuda:
    cudnn_deterministic: False
    cudnn_benchmark: False
    allow_tf32: True 